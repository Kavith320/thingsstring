# ThingsString Automation Engine v1 Master Guide

This document is the single source of truth for the ThingsString Automation Engine. It covers architecture, backend API, worker logic, and frontend integration requirements.

---

## 1. System Architecture

The Automation Engine is a background service that allows users to create intelligent rules (Flows) between sensors and actuators.

*   **API (Express)**: Manages Flow CRUD and historical logs.
*   **Database (MongoDB)**: Stores flow definitions, execution state, and logs.
*   **Scheduler (Agenda)**: Manages periodic execution of flows (Polling).
*   **Worker (Node.js)**: The execution brain. It fetches telemetry, evaluates logic, and updates device control states.

---

## 2. Core Data Models

### Automation Flow Object
Every rule created on the canvas is stored as an `Automation Flow`.

| Field | Type | Description |
| :--- | :--- | :--- |
| `_id` | ObjectId | Generated by MongoDB (required for updates/deletion). |
| `name` | string | User-defined name of the automation. |
| `deviceId` | string | **Sensor Hub ID.** The source of telemetry data. |
| `enabled` | boolean | Toggle status of the flow. |
| `intervalSec` | number | How often to poll data (5s - 3600s). |
| `metricPath` | string | JSON path to monitor (e.g. `data.temp` or `battery`). |
| **`condition`** | object | **Logic Rule.** (See Section 3). |
| **`action`** | object | **Command Target.** (See Section 4). |
| `cooldownSec` | number | Minimum wait time between triggers. |
| `ui_metadata` | object | Opaque JSON for storing canvas node positions/edges. |

---

## 3. Logical Condition Engine

The engine supports two types of trigger logic.

### A. Algebraic Operators (Preferred)
Define an explicit mathematical rule in the `condition` object:
- **Operators**: `>`, `<`, `>=`, `<=`, `==`, `!=`
- **Structure**: `{ "operator": ">", "value": 30 }`

### B. Delta Threshold (Fallback)
If no `condition` object is provided, the engine uses `deltaThreshold`.
- **Logic**: Triggers if `abs(currentValue - lastValue) > deltaThreshold`.

---

## 4. Multi-Hub Command Mapping

The engine allows for cross-device automation.
- **Source**: Telemetry is fetched from the top-level `deviceId`.
- **Target**: Commands are sent to the hub defined in `action.deviceId`.
- **Prerequisite**: The target hub actuator **must** be in `auto` mode in the Device Settings for the automation to fire.

---

## 5. API Reference

### Manage Flows (Requires Auth)
- **List All**: `GET /api/automation/flows` -> `{ ok: true, flows: [] }`
- **Create**: `POST /api/automation/flows` -> `{ ok: true, flow: { ... } }`
- **Update**: `PUT /api/automation/flows/:id` -> `{ ok: true, flow: { ... } }`
- **Delete**: `DELETE /api/automation/flows/:id` -> `{ ok: true }`

### Execution History
- **Logs**: `GET /api/automation/flows/:id/logs` -> `{ ok: true, logs: [] }`

---

## 6. Frontend Integration: Visual Designer

### Canvas Persistence
To keep nodes from resetting to `(0,0)`:
1.  Store your React Flow `nodes` and `edges` inside the `ui_metadata` object.
2.  The backend persists this object without modification.

### Action Commands
- Always use the key **`setValue`** when defining what value to send (e.g., `true` for ON).
- Map user-selected pins to the **`actuatorKey`** field.

---

## 7. Operational Commands (Server Admin)

### Start the Worker
```bash
npm run automation-worker
```

### Run with PM2 (Always On)
```bash
pm2 start src/automation/worker.js --name "things-automation"
pm2 save
```

### View Real-time Logs
```bash
pm2 logs things-automation
```
